<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>YT play/pause â€” v28</title>
<style>
  :root {
    --bg:#0b0b0c; --fg:#f5f7fa; --muted:#a4acb6; --card:#15161a;
    --accent:#3e56a8; /* subtle blue */
    --shadow:0 10px 30px rgba(0,0,0,.25);
    --btn:#2c323b; --btn-hover:#343a45; --chip:#22262d; --chip-border:#2f3540;
    --btn-grey:#59616c;        /* idle grey for play */
    --btn-pause:#4a515b;       /* subtle different grey for pause active */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans");}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  h2{font-size:16px;margin:0 0 8px;color:#cbd5e1}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a2d33;background:#0f1115;color:#fff;outline:none;font-size:16px}
  button{padding:10px 14px;border-radius:12px;border:0;background:var(--btn);color:#fff;font-weight:700;cursor:pointer;font-size:14px;white-space:nowrap}
  button:hover{background:var(--btn-hover)}
  .playerWrap{position:relative}
  iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:12px;background:#000}
  .pauseCoverPlayer{display:none;position:absolute;inset:0;border-radius:12px;background:rgba(0,0,0,.8);pointer-events:none;z-index:10}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-border);font-size:12px;cursor:pointer;transition:filter .15s, box-shadow .15s, background .15s}
  .chip:hover{filter:brightness(1.08)}
  .chip.active{box-shadow:0 0 0 2px var(--accent) inset;background:rgba(62,86,168,.18)}
  .btn-icon{height:52px;min-width:52px;padding:0 14px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--btn)}
  .btn-icon svg{width:22px;height:22px}
  .btn-wide{min-width:min(20vw,140px)} /* narrower so all 4 fit on S23 */
  .btn-play{background:var(--btn-grey)} /* grey when idle or paused */
  .btn-play.active{background:var(--accent); filter:saturate(.55) brightness(.92)} /* subtle blue when active */
  .btn-pause{background:var(--btn)}
  .btn-pause.active{background:var(--btn-pause)} /* subtle grey diff when paused */
  .btn-tab{background:transparent;border:1px solid #2f3540}
  .btn-tab.active{background:#1a1d23}
  .tabs{display:flex;gap:8px}
  .page{display:none}
  .page.active{display:block}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:520px;overflow:auto}
  .item{display:grid;grid-template-columns:auto 1fr auto auto auto auto;gap:8px;align-items:center;background:#0f1115;border:1px solid #2a2d33;border-radius:12px;padding:8px}
  .idx{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#23262d;border-radius:8px;color:#cbd5e1;font-size:12px}
  .titleEditable{border:0;background:transparent;color:#fff;font-size:14px;padding:8px;border-radius:8px}
  .titleEditable:focus{outline:1px solid #3a3f47;background:#111319}
  .banner{padding:10px 12px;border-radius:12px;background:#2a2d33;color:#e5e7eb;font-size:13px}
  .banner.danger{background:#3b1111;color:#fee2e2;border:1px solid #7f1d1d}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
  /* toggles */
  .switch{position:relative;display:inline-block;width:56px;height:32px;vertical-align:middle}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#3a3f47;border-radius:999px;transition:.2s}
  .slider:before{position:absolute;content:"";height:24px;width:24px;left:4px;top:4px;background:#fff;border-radius:50%;transition:.2s}
  input:checked + .slider{background:#16a34a}
  input:checked + .slider:before{transform:translateX(24px)}
  .switchWrap{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
  .switchLabel{font-size:12px;color:#9aa3ad}
  /* time inputs inline */
  .timesWrap{display:flex;gap:24px;align-items:flex-end;flex-wrap:wrap}
  .timeGroup{display:flex;align-items:center;gap:8px}
  .timeGroup label{margin:0}
  .timeGroup input[type="number"]{width:86px;text-align:right}
  /* controls one line */
  .topControls{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;overflow-x:auto}
  /* watermark */
  .watermark{position:fixed;right:16px;top:16px;background:rgba(0,0,0,.65);padding:8px 12px;border-radius:10px;z-index:50;opacity:0;transition:opacity .4s}
  .watermark.show{opacity:1}
  /* labeled small buttons on URL page */
  .btn-small{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:10px}
  .btn-small svg{width:18px;height:18px}
  /* toggle block under presets */
  .togglesRow{display:flex;gap:24px;flex-wrap:wrap;margin-top:12px}
</style>
</head>
<body>
<div class="wrap" id="appRoot">
  <div id="fileBanner" class="banner danger" style="display:none">
    Running from <span class="mono">file://</span>. Serve via a local server (e.g., <span class="mono">python -m http.server</span>) to avoid embed errors.
  </div>

  <div class="tabs">
    <button id="tabPlayer" class="btn-tab active">Player</button>
    <button id="tabUrls" class="btn-tab">URL list=</button>
  </div>

  <div class="card page active" id="pagePlayer">
    <div class="playerWrap" id="playerWrap">
      <div id="player"></div>
      <div id="pauseCoverPlayer" class="pauseCoverPlayer" aria-hidden="true"></div>
    </div>

    <div class="topControls" style="margin-top:12px">
      <button id="prevBtn" title="Previous" class="btn-icon btn-wide" aria-label="Previous">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6V6zm3.5 6 8.5 6V6l-8.5 6z"/></svg>
      </button>

      <button id="playBtn" class="btn-icon btn-wide btn-play" aria-pressed="false" aria-label="Play">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7L8 5z"/></svg>
      </button>

      <button id="pauseBtn" class="btn-icon btn-wide btn-pause" aria-pressed="false" aria-label="Pause">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
      </button>

      <button id="nextBtn" title="Next" class="btn-icon btn-wide" aria-label="Next">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2V6zM6 18l8.5-6L6 6v12z"/></svg>
      </button>
    </div>

    <!-- Times in one line -->
    <div class="timesWrap" style="margin-top:10px">
      <div class="timeGroup">
        <label for="playMin">Play (mm:ss)</label>
        <input id="playMin" type="number" min="0" step="1" value="0" title="Play minutes">
        <span style="opacity:.65">:</span>
        <input id="playSec" type="number" min="0" step="1" value="10" title="Play seconds">
      </div>
      <div class="timeGroup">
        <label for="pauseMin">Pause (mm:ss)</label>
        <input id="pauseMin" type="number" min="0" step="1" value="0" title="Pause minutes">
        <span style="opacity:.65">:</span>
        <input id="pauseSec" type="number" min="0" step="1" value="5" title="Pause seconds">
      </div>
    </div>

    <h2>Quick presets (last 10)</h2>
    <div class="chips" id="presetChips"></div>

    <!-- Moved toggles under presets -->
    <div class="togglesRow">
      <div class="switchWrap">
        <div class="switchLabel">Dim on pause</div>
        <label class="switch" title="Dim player on pause"><input id="dimToggle" type="checkbox"><span class="slider"></span></label>
      </div>
      <div class="switchWrap">
        <div class="switchLabel">Random</div>
        <label class="switch" title="Play random items"><input id="randToggle" type="checkbox"><span class="slider"></span></label>
      </div>
      <div class="switchWrap">
        <div class="switchLabel">Bypass timings</div>
        <label class="switch" title="Play full video, ignore timings"><input id="bypassToggle" type="checkbox"><span class="slider"></span></label>
      </div>
      <div class="switchWrap">
        <div class="switchLabel">Fullscreen</div>
        <label class="switch" title="Open in fullscreen (mobile friendly)"><input id="fsToggle" type="checkbox" checked><span class="slider"></span></label>
      </div>
    </div>

    <div class="banner" style="margin-top:10px">Space = Play. Pause/Break = Pause. â† / â†’ = Previous / Next.</div>
  </div>

  <div class="card page" id="pageUrls">
    <h2>URL list</h2>
    <div class="row" style="gap:8px;align-items:flex-start">
      <div style="flex:1">
        <label>Add YouTube URL (video or playlist link â€” only the video id is used)</label>
        <input id="urlInput" type="text" placeholder="Paste YouTube URL">
      </div>
      <div class="row" style="gap:8px;margin-top:22px">
        <button id="addUrlBtn" class="btn-small" title="Add URL">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2h5z"/></svg>
          <span>Add</span>
        </button>
        <button id="exportBtn" class="btn-small" title="Export list as JSON">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2 6.5 7.5l1.4 1.4L11 5.8V16h2V5.8l3.1 3.1 1.4-1.4L12 2z"/></svg>
          <span>Export</span>
        </button>
        <input type="file" id="importFile" accept=".json,application/json" style="display:none">
        <button id="importBtn" class="btn-small" title="Import list from JSON">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9v10H5V9H3v12h18V9h-2zM11 16V5.8L8 8.9 6.6 7.5 12 2l5.4 5.5L16 8.9l-3-3.1V16h-2z"/></svg>
          <span>Import</span>
        </button>
      </div>
    </div>
    <div class="banner" style="margin-top:8px">Unlimited items. Titles auto-fetched; click a title to edit. Use â†‘ â†“ or â‡¡Top to reorder. Double-click title to play.</div>
    <div class="list" id="list"></div>
  </div>
</div>

<div id="wm" class="watermark">Jimmy James - 04.11.2025</div>

<script>
(function(){
  if(location.protocol === 'file:'){
    document.getElementById('fileBanner').style.display = 'block';
  }
  // watermark 5s
  const wm=document.getElementById('wm');
  setTimeout(()=> wm.classList.add('show'), 80);
  setTimeout(()=> wm.classList.remove('show'), 5000);
})();

const S_LIST='YT21_LIST';
const S_SETTINGS='YT21_SETTINGS';
const S_PRESETS='YT21_PRESETS';

const tabPlayer=document.getElementById('tabPlayer');
const tabUrls=document.getElementById('tabUrls');
const pagePlayer=document.getElementById('pagePlayer');
const pageUrls=document.getElementById('pageUrls');
function setTab(which){
  if(which==='player'){ tabPlayer.classList.add('active'); tabUrls.classList.remove('active'); pagePlayer.classList.add('active'); pageUrls.classList.remove('active'); }
  else { tabUrls.classList.add('active'); tabPlayer.classList.remove('active'); pageUrls.classList.add('active'); pagePlayer.classList.remove('active'); }
}
tabPlayer.onclick=()=>setTab('player');
tabUrls.onclick=()=>setTab('urls');

function parseVideoId(input){
  input=(input||'').trim();
  if(!input) return null;
  try{
    const u = new URL(input);
    if (u.hostname.includes('youtube.com')){
      const v = u.searchParams.get('v');
      if(v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;
      return null;
    }
    if (u.hostname === 'youtu.be'){
      const p = u.pathname.slice(1);
      if (p && /^[a-zA-Z0-9_-]{11}$/.test(p)) return p;
      return null;
    }
  }catch(e){}
  if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
  return null;
}
function idToWatchUrl(id){ return 'https://www.youtube.com/watch?v='+encodeURIComponent(id); }
function normalize(minEl, secEl){
  let m=parseInt(minEl.value||"0",10); if(isNaN(m)) m=0;
  let s=parseInt(secEl.value||"0",10); if(isNaN(s)) s=0;
  if (s>=60){ m+=Math.floor(s/60); s=s%60; }
  if (s<0){ const b=Math.ceil(Math.abs(s)/60); m=Math.max(0,m-b); s=(s%60+60)%60; }
  minEl.value=m; secEl.value=s;
  return m*60+s;
}
function setFromSeconds(minEl, secEl, total){
  total=Math.max(0,Math.floor(total||0));
  const m=Math.floor(total/60), s=total%60; minEl.value=m; secEl.value=s;
}
function selectOnFocus(el){ el.addEventListener('focus', ()=> el.select()); }
function fmtSec(t){ t=Math.max(0,Math.floor(t||0)); const m=Math.floor(t/60), s=t%60; return m+":"+String(s).padStart(2,'0'); }

['playMin','playSec','pauseMin','pauseSec'].forEach(id=> selectOnFocus(document.getElementById(id)) );

let items = []; // {id,title}
let currentIndex = -1;

// Persistence
function saveList(){ localStorage.setItem(S_LIST, JSON.stringify(items)); }
function loadList(){
  try{
    const raw = localStorage.getItem(S_LIST);
    if(raw){ items = JSON.parse(raw) || []; }
  }catch(e){ items=[]; }
}
async function fetchTitleForId(id){
  const url = idToWatchUrl(id);
  try{
    const r = await fetch('https://noembed.com/embed?url='+encodeURIComponent(url));
    if(r.ok){
      const j = await r.json();
      if(j && j.title) return j.title;
    }
  }catch(e){}
  try{
    const r = await fetch('https://www.youtube.com/oembed?format=json&url='+encodeURIComponent(url));
    if(r.ok){
      const j = await r.json();
      if(j && j.title) return j.title;
    }
  }catch(e){}
  return '(untitled video)';
}
async function addItemByUrl(rawUrl){
  const id = parseVideoId(rawUrl);
  if(!id){ return; }
  const title = await fetchTitleForId(id);
  items.push({id, title});
  saveList();
  renderList();
}
function moveItem(idx, dir){
  const ni = idx + dir;
  if(ni<0 || ni>=items.length) return;
  const tmp = items[idx]; items[idx] = items[ni]; items[ni] = tmp;
  if(currentIndex===idx) currentIndex=ni;
  else if(currentIndex===ni) currentIndex=idx;
  saveList(); renderList();
}
function moveToTop(idx){
  if(idx<=0) return;
  const [x]=items.splice(idx,1);
  items.unshift(x);
  if(currentIndex===idx) currentIndex=0;
  saveList(); renderList();
}
function updateTitle(idx, newTitle){
  items[idx].title = newTitle.trim() || items[idx].title;
  saveList(); renderList(false);
}
function renderList(){
  const list = document.getElementById('list');
  list.innerHTML='';
  items.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className='item';
    const idxBox = document.createElement('div'); idxBox.className='idx'; idxBox.textContent = idx+1;
    const title = document.createElement('input'); title.className='titleEditable'; title.value = it.title || '(untitled video)';
    title.title = 'Edit title. Double-click to play.';
    title.addEventListener('change', ()=> updateTitle(idx, title.value));
    title.addEventListener('dblclick', ()=>{ loadByIndex(idx, true); setTab('player'); });
    const btnPlay = document.createElement('button'); btnPlay.className='btn-icon'; btnPlay.title='Play this';
    btnPlay.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7L8 5z"/></svg>';
    btnPlay.onclick=()=>{ loadByIndex(idx,true); setTab('player'); };
    const btnUp = document.createElement('button'); btnUp.className='btn-icon'; btnUp.title='Move up';
    btnUp.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12 12 4 4 12z"/></svg>';
    btnUp.onclick=()=>moveItem(idx,-1);
    const btnDown = document.createElement('button'); btnDown.className='btn-icon'; btnDown.title='Move down';
    btnDown.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 12l8 8 8-8-1.41-1.41L13 16.17V4h-2v12.17L5.41 10.59 4 12z"/></svg>';
    btnDown.onclick=()=>moveItem(idx,1);
    const btnTop = document.createElement('button'); btnTop.className='btn-icon'; btnTop.title='Move to top';
    btnTop.textContent='â‡¡Top'; btnTop.onclick=()=>moveToTop(idx);
    row.appendChild(idxBox); row.appendChild(title); row.appendChild(btnPlay); row.appendChild(btnUp); row.appendChild(btnDown); row.appendChild(btnTop);
    if(idx===currentIndex){ row.style.boxShadow='0 0 0 2px rgba(62,86,168,.5) inset'; }
    list.appendChild(row);
  });
}
function exportJSON(){
  const data = items.map(it=>({url:idToWatchUrl(it.id), title: it.title||''}));
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'yt_v28_list.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
function filterToIdList(arr){
  const out=[];
  for(const entry of arr){
    const src = (entry && (entry.url||entry.href||entry.id||entry.source)) || '';
    const id = parseVideoId(String(src||''));
    if(id) out.push({id, title: (entry.title||'').trim() || ''});
  }
  return out;
}
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const arr = JSON.parse(reader.result);
      const cleaned = filterToIdList(arr);
      if(cleaned.length===0){ return; }
      items = cleaned.map(o=>({id:o.id,title:o.title}));
      saveList(); renderList();
      // Settings are preserved; no change to S_SETTINGS
    }catch(e){}
  };
  reader.readAsText(file);
}

// Settings / Presets
function saveSettings(play,pause,dim,rand,bypass,fsPref){
  const base = {play,pause,dim,rand,bypass};
  if(typeof fsPref==='boolean') base.fs = fsPref;
  localStorage.setItem(S_SETTINGS, JSON.stringify(base));
}
function loadSettings(){
  try{
    const j = JSON.parse(localStorage.getItem(S_SETTINGS)||'null');
    if(j){
      setFromSeconds(document.getElementById('playMin'),document.getElementById('playSec'), j.play??10);
      setFromSeconds(document.getElementById('pauseMin'),document.getElementById('pauseSec'), j.pause??5);
      document.getElementById('dimToggle').checked = !!j.dim;
      document.getElementById('randToggle').checked = !!j.rand;
      document.getElementById('bypassToggle').checked = !!j.bypass;
      if(typeof j.fs==='boolean'){ document.getElementById('fsToggle').checked = j.fs; }
    }
  }catch(e){}
}
function pushPreset(play, pause){
  let arr=[]; try{ arr = JSON.parse(localStorage.getItem(S_PRESETS)||'[]') }catch(e){}
  const key = play+':'+pause;
  arr = arr.filter(x=> (x && (x.play+':'+x.pause)!==key));
  arr.unshift({play, pause, at: Date.now()});
  if(arr.length>10) arr = arr.slice(0,10);
  localStorage.setItem(S_PRESETS, JSON.stringify(arr));
  renderPresetChips();
  markActivePreset(play, pause);
}
function renderPresetChips(){
  let arr=[]; try{ arr = JSON.parse(localStorage.getItem(S_PRESETS)||'[]') }catch(e){}
  const holder = document.getElementById('presetChips'); holder.innerHTML='';
  arr.forEach(p=>{
    const chip = document.createElement('div');
    chip.className='chip';
    chip.dataset.key = p.play+':'+p.pause;
    chip.textContent = 'Play '+fmtSec(p.play)+' | Pause '+fmtSec(p.pause);
    chip.title = 'Set Play '+fmtSec(p.play)+' / Pause '+fmtSec(p.pause);
    chip.onclick = ()=>{
      setFromSeconds(document.getElementById('playMin'),document.getElementById('playSec'), p.play);
      setFromSeconds(document.getElementById('pauseMin'),document.getElementById('pauseSec'), p.pause);
      saveSettings(p.play,p.pause, document.getElementById('dimToggle').checked, document.getElementById('randToggle').checked, document.getElementById('bypassToggle').checked, document.getElementById('fsToggle').checked);
      markActivePreset(p.play, p.pause);
    };
    holder.appendChild(chip);
  });
  markActivePreset(getPlaySec(), getPauseSec());
}
function markActivePreset(play, pause){
  const key = (Math.max(0,Math.floor(play)) + ':' + Math.max(0,Math.floor(pause)));
  document.querySelectorAll('#presetChips .chip').forEach(ch=>{
    ch.classList.toggle('active', ch.dataset.key===key);
  });
}

function getPlaySec(){ return normalize(document.getElementById('playMin'),document.getElementById('playSec')) }
function getPauseSec(){ return normalize(document.getElementById('pauseMin'),document.getElementById('pauseSec')) }

// YouTube API
let player;
let ytReadyResolve; const ytReady=new Promise(res=>ytReadyResolve=res);
window.onYouTubeIframeAPIReady=()=>ytReadyResolve();
const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag);

const pauseCoverPlayer=document.getElementById('pauseCoverPlayer');
const dimToggle=document.getElementById('dimToggle');
const randToggle=document.getElementById('randToggle');
const bypassToggle=document.getElementById('bypassToggle');
const fsToggle=document.getElementById('fsToggle');

function installAllowAttrs(){
  const iframe = document.querySelector('#player iframe');
  if(iframe){
    iframe.setAttribute('allow',"autoplay; encrypted-media; picture-in-picture; fullscreen");
    iframe.setAttribute('allowfullscreen','');
  }
}

// Fullscreen helpers
function requestFS(){
  const el = document.documentElement;
  if (!document.fullscreenElement && el.requestFullscreen){
    el.requestFullscreen({navigationUI:'hide'}).catch(()=>{});
  }
}
function maybeAutoFS(){
  if(fsToggle.checked){ requestFS(); }
}

function onStateChange(e){
  if (e.data===YT.PlayerState.PAUSED || e.data===YT.PlayerState.UNSTARTED){
    if (dimToggle.checked) pauseCoverPlayer.style.display='block';
    setPauseUIActive(true);
    setPlayUIActive(false);
  }
  if (e.data===YT.PlayerState.PLAYING || e.data===YT.PlayerState.BUFFERING){
    pauseCoverPlayer.style.display='none';
    setPauseUIActive(false);
    setPlayUIActive(true);
  }
}
function onError(e){ console.warn('YT error', e && e.data); }
function ensurePlayer(id){
  const origin = (location.origin && location.origin!=='null') ? location.origin : undefined;
  if(!player){
    player = new YT.Player('player',{
      videoId: id||'',
      playerVars:{ enablejsapi:1, origin:origin, rel:0, modestbranding:1, playsinline:1 },
      events:{ onReady:()=>{ installAllowAttrs(); }, onStateChange:onStateChange, onError:onError }
    });
    const t=setInterval(()=>{ installAllowAttrs(); if(document.querySelector('#player iframe')) clearInterval(t); },50);
  }else if(id){
    player.loadVideoById(id);
  }
}
async function gestureSafePlay(){
  try{ player.playVideo(); }catch(e){}
  const ok = await waitForPlaying(10);
  if (ok) return true;
  const wasMuted = player.isMuted && player.isMuted();
  try{ player.mute(); }catch(e){}
  try{ player.playVideo(); }catch(e){}
  const ok2 = await waitForPlaying(10);
  if (ok2 && !wasMuted){ setTimeout(()=>{ try{ player.unMute(); }catch(e){} }, 500); }
  return ok2;
}
function waitForPlaying(maxTries){
  return new Promise(res=>{
    let tries=0;
    const iv=setInterval(()=>{
      tries++;
      const st=player.getPlayerState && player.getPlayerState();
      if (st===YT.PlayerState.PLAYING || st===YT.PlayerState.BUFFERING){ clearInterval(iv); res(true); }
      if (tries>maxTries){ clearInterval(iv); res(false); }
    },80);
  });
}

let timers={p:null,q:null};
let stepRunning=false;
let resumeAt=0;
function clearTimers(){ if(timers.p){clearTimeout(timers.p)} if(timers.q){clearTimeout(timers.q)} timers={p:null,q:null}; }
function setPlayUIActive(on){
  const btn=document.getElementById('playBtn');
  btn.classList.toggle('active', !!on);
  btn.setAttribute('aria-pressed', on?'true':'false');
}
function setPauseUIActive(on){
  const btn=document.getElementById('pauseBtn');
  btn.classList.toggle('active', !!on);
  btn.setAttribute('aria-pressed', on?'true':'false');
}

async function startPlainPlay(){
  stepRunning=false;
  clearTimers();
  setPauseUIActive(false);
  setPlayUIActive(true);
  maybeAutoFS();
  const ok = await gestureSafePlay();
  if(!ok){ setPlayUIActive(false); }
}

async function startPlayStepper(){
  if(!player){ return; }
  if(bypassToggle.checked){
    saveSettings(getPlaySec(), getPauseSec(), dimToggle.checked, randToggle.checked, true, fsToggle.checked);
    return startPlainPlay();
  }
  stepRunning=true; clearTimers();
  setPlayUIActive(true);
  const playS=Math.max(1,getPlaySec());
  const pauseS=Math.max(1,getPauseSec());
  saveSettings(playS,pauseS, dimToggle.checked, randToggle.checked, false, fsToggle.checked);
  pushPreset(playS,pauseS);
  async function cyclePlay(){
    if(!stepRunning) return;
    try{ if(resumeAt>0){ player.seekTo(resumeAt,true); } }catch(e){}
    pauseCoverPlayer.style.display='none';
    setPauseUIActive(false);
    maybeAutoFS();
    const ok = await gestureSafePlay();
    if(!ok){ stepRunning=false; setPlayUIActive(false); return; }
    timers.p=setTimeout(cyclePause, playS*1000);
  }
  function cyclePause(){
    if(!stepRunning) return;
    try{ resumeAt = player.getCurrentTime()||0; player.pauseVideo(); }catch(e){}
    if (dimToggle.checked) pauseCoverPlayer.style.display='block';
    setPauseUIActive(true);
    setPlayUIActive(false);
    timers.q=setTimeout(()=>{
      if(randToggle.checked && items.length>0){
        let nxt = Math.floor(Math.random()*items.length);
        if(items.length>1 && currentIndex>=0 && nxt===currentIndex) nxt=(nxt+1)%items.length;
        loadByIndex(nxt, false);
      }
      cyclePlay();
    }, pauseS*1000);
  }
  cyclePlay();
}
function pauseNow(){
  stepRunning=false;
  clearTimers();
  try{ player.pauseVideo(); }catch(e){}
  if (document.getElementById('dimToggle').checked) pauseCoverPlayer.style.display='block';
  setPauseUIActive(true);
  setPlayUIActive(false);
}

function loadByIndex(idx, startCycle){
  if(idx<0 || idx>=items.length) return;
  currentIndex = idx;
  const it=items[idx];
  resumeAt=0;
  ensurePlayer(it.id);
  renderList();
  if(startCycle){ startPlayStepper(); }
}

document.addEventListener('keydown',(e)=>{
  if(e.target && (/INPUT|TEXTAREA|SELECT/).test(e.target.tagName)) return;
  if(e.key===' '){ startPlayStepper(); e.preventDefault();
  }else if(e.key==='Pause'){ pauseNow(); e.preventDefault();
  }else if(e.key==='ArrowRight'){ const ni=nextIndex(); if(ni>=0){ loadByIndex(ni,true);} e.preventDefault();
  }else if(e.key==='ArrowLeft'){ const pi=prevIndex(); if(pi>=0){ loadByIndex(pi,true);} e.preventDefault(); }
}, true);

function nextIndex(){
  if(items.length===0) return -1;
  if(randToggle.checked){
    let nxt = Math.floor(Math.random()*items.length);
    if(items.length>1 && currentIndex>=0 && nxt===currentIndex) nxt=(nxt+1)%items.length;
    return nxt;
  }
  return (currentIndex+1) % items.length;
}
function prevIndex(){
  if(items.length===0) return -1;
  if(randToggle.checked){
    let nxt = Math.floor(Math.random()*items.length);
    if(items.length>1 && currentIndex>=0 && nxt===currentIndex) nxt=(nxt+items.length-1)%items.length;
    return nxt;
  }
  return (currentIndex-1+items.length) % items.length;
}

document.getElementById('playBtn').addEventListener('click', startPlayStepper);
document.getElementById('pauseBtn').addEventListener('click', pauseNow);
document.getElementById('nextBtn').addEventListener('click', ()=>{ const ni=nextIndex(); if(ni>=0) loadByIndex(ni,true); });
document.getElementById('prevBtn').addEventListener('click', ()=>{ const pi=prevIndex(); if(pi>=0) loadByIndex(pi,true); });

document.getElementById('addUrlBtn').addEventListener('click', async()=>{
  const raw = document.getElementById('urlInput').value.trim();
  if(!raw) return;
  await addItemByUrl(raw);
  document.getElementById('urlInput').value='';
  if(currentIndex===-1 && items.length>0){ loadByIndex(0,false); }
});
document.getElementById('exportBtn').addEventListener('click', exportJSON);
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f=e.target.files && e.target.files[0];
  if(f) importJSONFile(f);
  e.target.value='';
});

['playMin','playSec','pauseMin','pauseSec'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    const play = getPlaySec();
    const pause = getPauseSec();
    saveSettings(play,pause, document.getElementById('dimToggle').checked, document.getElementById('randToggle').checked, document.getElementById('bypassToggle').checked, document.getElementById('fsToggle').checked);
    markActivePreset(play, pause);
  });
});

document.getElementById('fsToggle').addEventListener('change', (e)=>{
  saveSettings(getPlaySec(), getPauseSec(), document.getElementById('dimToggle').checked, document.getElementById('randToggle').checked, document.getElementById('bypassToggle').checked, e.target.checked);
  if(e.target.checked){ requestFS(); } else { if(document.fullscreenElement){ document.exitFullscreen().catch(()=>{}); } }
});


// Seed URLs (always append on load; dedupe by id)
const SEED_URLS=[
  "https://www.youtube.com/watch?v=jiJ-wZch_vQ",
  "https://www.youtube.com/watch?v=4yv4ea1pFp4&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=3",
  "https://www.youtube.com/watch?v=pHqC1cV4tzQ&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=2",
  "https://www.youtube.com/watch?v=5oKW1UqWnmY&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=5",
  "https://www.youtube.com/watch?v=ekfw9u0Jta8&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=6",
  "https://www.youtube.com/watch?v=_xUzD-8RtHE&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=7",
  "https://www.youtube.com/watch?v=DrL81SOUv9o&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=8",
  "https://www.youtube.com/watch?v=vKb9xwSRrsU&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=9",
  "https://www.youtube.com/watch?v=TI-1YVahRbs&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=11",
  "https://www.youtube.com/watch?v=CAwTpysdDuY&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=12",
  "https://www.youtube.com/watch?v=jXRuLeCOyLY&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=13",
  "https://www.youtube.com/watch?v=o8t6C-q5NSk&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=18",
  "https://www.youtube.com/watch?v=WvpR4Ipmjj4&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=14",
  "https://www.youtube.com/watch?v=ISRmHPuuX5s&list=PLj_R-xNx8BKgoruOpG2U4dOmjuWZUvlsH&index=16"
];

function ensureSeedUrlsPresent(){
  const existing = new Set(items.map(it=>it.id));
  const toAdd = [];
  for(const u of SEED_URLS){
    const id = parseVideoId(u);
    if(id && !existing.has(id)){
      toAdd.push({id, title:'(loading...)'});
      existing.add(id);
    }
  }
  if(toAdd.length){
    items = items.concat(toAdd);
    saveList();
    toAdd.forEach(async (it)=>{
      const t = await fetchTitleForId(it.id);
      it.title = t; saveList(); renderList();
    });
  }
}

(async function init(){
  await ytReady;
  // Settings
  loadSettings();
  // List
  loadList();
  if(items.length===0){
    for(const u of SEED_URLS){
      const id = parseVideoId(u);
      if(id) items.push({id, title:'(loading...)'});
    }
    saveList();
    items.forEach(async (it)=>{
      const t = await fetchTitleForId(it.id);
      it.title = t; saveList(); renderList();
    });
  }
  renderList();
  ensurePlayer(items[0]?.id || "jiJ-wZch_vQ");
  // Presets
  renderPresetChips();
  // Try to go fullscreen shortly after load if pref is already on (mobile UX)
  if(document.getElementById('fsToggle').checked){
    setTimeout(requestFS, 400);
    ['touchstart','click'].forEach(ev=>{
      window.addEventListener(ev, function once(){ requestFS(); window.removeEventListener(ev, once, {passive:true}); }, {passive:true});
    });
  }
})();
</script>
</body>
</html>
